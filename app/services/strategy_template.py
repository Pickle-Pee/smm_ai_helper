# app/services/strategy_template.py
from __future__ import annotations

from typing import Any, Dict, Optional


_STRATEGY_KEYWORDS = (
    "стратег",
    "продвиж",
    "маркетинг план",
    "план продвиж",
    "go-to-market",
    "gtm",
    "growth",
    "запуск",
    "acquisition",
)


def is_strategy_like(text: str) -> bool:
    t = (text or "").lower()
    return any(k in t for k in _STRATEGY_KEYWORDS)


def build_strategy_scaffold(
    user_message: str,
    facts_json: Dict[str, Any],
    url_summary: Optional[Dict[str, Any]] = None,
) -> str:
    """
    Возвращает “скелет” ответа, который мы подмешиваем в user prompt,
    чтобы стратегия была конкретной и без допроса пользователя.
    """
    brand = (facts_json or {}).get("brand_name") or "бренд"
    product = (facts_json or {}).get("product_description") or "продукт/сервис"
    goals = (facts_json or {}).get("goals") or "рост установок/заявок/выручки"

    url_hint = ""
    if url_summary:
        # Не выдумываем — просто подсказываем модели, что есть выжимка
        url_hint = (
            "\nУ пользователя есть ссылки, по ним предоставлен url_summary. "
            "Используй только то, что там реально есть.\n"
        )

    return f"""
Ты делаешь стратегию продвижения. НЕ начинай с брифа и серии вопросов.

Вход:
- user_request: {user_message}
- brand: {brand}
- product: {product}
- goals: {goals}
{url_hint}

ОБЯЗАТЕЛЬНО:
- Дай стратегию СРАЗУ на основе разумных допущений (assumptions).
- follow_up_question: либо null, либо 1 вопрос (самый критичный, без которого реально нельзя).
- Никакой банальщины вида “определите ЦА/выберите каналы” без конкретики.

СФОРМИРУЙ ОТВЕТ ПО ШАБЛОНУ (коротко и конкретно):

1) Позиционирование (2–3 строки)
- Кто/для кого/в чём выгода (без воды)
- 2–3 отличия от типовых конкурентов (если не знаешь — как гипотезы)

2) Быстрые win'ы на 7 дней (3–6 пунктов)
- конкретные действия + результат/метрика

3) Каналы и механики (выбери 2–4 канала максимум)
Для каждого:
- Зачем канал (роль в воронке)
- 2 гипотезы креативов (угол + формат + кому показываем)
- Как измерять (1–2 метрики)

4) 3 сценария бюджета (MIN / MID / MAX)
Для каждого:
- Что именно делаем (объём креативов/посевов/инфлюенсеров)
- Какая ключевая метрика успеха (North Star)
- Стоп-правило (когда выключаем)

5) План тестов рекламы (если уместно) — 5–8 гипотез
Формат списка:
- Канал → аудитория → креативный угол → CTA → метрика успеха

6) Actions (2–4 кнопки) — только конкретные следующие шаги
Примеры хороших:
- “Сгенерировать 8 креативных углов под продукт”
- “Сделать план тестов рекламы на 7 дней”
- “Составить контент-план на 10 постов под Telegram/VK”
- “Разобрать конкурентов: 10 офферов и их углы”
""".strip()
